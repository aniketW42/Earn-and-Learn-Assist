{% extends "base.html" %}
{% load static %}

{% block title %}Department Payment Budget - ENL Assist{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="page-title mb-1">
                            <i class="fas fa-chart-pie text-info me-3"></i>Department Payment Budget
                        </h2>
                        <p class="text-muted mb-0">
                            {% if view_type == 'monthly' %}
                                Overview of payment budget for 
                                {% if current_month == 1 %}January{% elif current_month == 2 %}February{% elif current_month == 3 %}March{% elif current_month == 4 %}April{% elif current_month == 5 %}May{% elif current_month == 6 %}June{% elif current_month == 7 %}July{% elif current_month == 8 %}August{% elif current_month == 9 %}September{% elif current_month == 10 %}October{% elif current_month == 11 %}November{% elif current_month == 12 %}December{% endif %} {{ current_year }}
                            {% elif view_type == 'custom' %}
                                Overview of payment budget from {{ start_date }} to {{ end_date }}
                            {% else %}
                                Overview of payment budget allocation for {{ current_year }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{% url 'export_payment_report' %}?type=all_departments&year={{ current_year }}&month=12" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Export Annual Report
                        </a>
                        {% if user.role == 'el_coordinator' %}
                        <a href="{% url 'payment_calculation_bulk' %}" class="btn btn-success">
                            <i class="fas fa-calculator me-2"></i>Calculate Payments
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-bottom">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter text-primary me-2"></i>Filter Options
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">View Type</label>
                            <select name="view_type" class="form-select" onchange="toggleDateFields()">
                                <option value="yearly" {% if view_type == 'yearly' %}selected{% endif %}>Yearly</option>
                                <option value="monthly" {% if view_type == 'monthly' %}selected{% endif %}>Monthly</option>
                                <option value="custom" {% if view_type == 'custom' %}selected{% endif %}>Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year</label>
                            <select name="year" class="form-select">
                                <option value="2023" {% if current_year == 2023 %}selected{% endif %}>2023</option>
                                <option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
                                <option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
                                <option value="2026" {% if current_year == 2026 %}selected{% endif %}>2026</option>
                                <option value="2027" {% if current_year == 2027 %}selected{% endif %}>2027</option>
                            </select>
                        </div>
                        <div class="col-md-2" id="month-field" style="{% if view_type != 'monthly' %}display: none;{% endif %}">
                            <label class="form-label">Month</label>
                            <select name="month" class="form-select">
                                <option value="1" {% if current_month == 1 %}selected{% endif %}>January</option>
                                <option value="2" {% if current_month == 2 %}selected{% endif %}>February</option>
                                <option value="3" {% if current_month == 3 %}selected{% endif %}>March</option>
                                <option value="4" {% if current_month == 4 %}selected{% endif %}>April</option>
                                <option value="5" {% if current_month == 5 %}selected{% endif %}>May</option>
                                <option value="6" {% if current_month == 6 %}selected{% endif %}>June</option>
                                <option value="7" {% if current_month == 7 %}selected{% endif %}>July</option>
                                <option value="8" {% if current_month == 8 %}selected{% endif %}>August</option>
                                <option value="9" {% if current_month == 9 %}selected{% endif %}>September</option>
                                <option value="10" {% if current_month == 10 %}selected{% endif %}>October</option>
                                <option value="11" {% if current_month == 11 %}selected{% endif %}>November</option>
                                <option value="12" {% if current_month == 12 %}selected{% endif %}>December</option>
                            </select>
                        </div>
                        <div class="col-md-2" id="start-date-field" style="{% if view_type != 'custom' %}display: none;{% endif %}">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                        </div>
                        <div class="col-md-2" id="end-date-field" style="{% if view_type != 'custom' %}display: none;{% endif %}">
                            <label class="form-label">End Date</label>
                            <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block">
                                <i class="fas fa-search me-1"></i>Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-building fa-2x mb-3 opacity-75"></i>
                    <h3 class="mb-1">{{ budget_data|length }}</h3>
                    <p class="mb-0">Active Departments</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-3 opacity-75"></i>
                    <h3 class="mb-1">
                        {{ total_students|default:"0" }}
                    </h3>
                    <p class="mb-0">Total Students</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-rupee-sign fa-2x mb-3 opacity-75"></i>
                    <h3 class="mb-1">₹{{ total_budget|floatformat:0 }}</h3>
                    <p class="mb-0">Total Budget {{ current_year }}</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar fa-2x mb-3 opacity-75"></i>
                    <h3 class="mb-1">₹{% widthratio total_budget 12 1 %}</h3>
                    <p class="mb-0">Avg. Monthly</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Budget Table -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-table text-primary me-2"></i>Department-wise Budget Breakdown
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if budget_data %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="ps-3 text-white">Department</th>
                                        <th class="text-white">Students</th>
                                        {% if view_type == 'monthly' %}
                                            <th class="text-white">
                                                {% if current_month == 1 %}January{% elif current_month == 2 %}February{% elif current_month == 3 %}March{% elif current_month == 4 %}April{% elif current_month == 5 %}May{% elif current_month == 6 %}June{% elif current_month == 7 %}July{% elif current_month == 8 %}August{% elif current_month == 9 %}September{% elif current_month == 10 %}October{% elif current_month == 11 %}November{% elif current_month == 12 %}December{% endif %} {{ current_year }}
                                            </th>
                                        {% elif view_type == 'custom' %}
                                            <th class="text-white">Custom Period</th>
                                        {% else %}
                                            <th class="text-white">Jan-Mar</th>
                                            <th class="text-white">Apr-Jun</th>
                                            <th class="text-white">Jul-Sep</th>
                                            <th class="text-white">Oct-Dec</th>
                                        {% endif %}
                                        <th class="text-white">Total</th>
                                        <th class="text-white">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dept_data in budget_data %}
                                    <tr>
                                        <td class="ps-3">
                                            <div>
                                                <strong>{{ dept_data.department.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ dept_data.department.code }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ dept_data.student_count }}</span>
                                        </td>
                                        {% if view_type == 'monthly' %}
                                        <td>
                                            <small class="text-primary">
                                                ₹{{ dept_data.current_month_total|floatformat:0 }}
                                            </small>
                                        </td>
                                        {% elif view_type == 'custom' %}
                                        <td>
                                            <small class="text-primary">
                                                ₹{{ dept_data.year_total|floatformat:0 }}
                                            </small>
                                        </td>
                                        {% else %}
                                        <td>
                                            <small class="text-success">
                                                ₹{{ dept_data.quarterly_totals.0|floatformat:0 }}
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-info">
                                                ₹{{ dept_data.quarterly_totals.1|floatformat:0 }}
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-warning">
                                                ₹{{ dept_data.quarterly_totals.2|floatformat:0 }}
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-danger">
                                                ₹{{ dept_data.quarterly_totals.3|floatformat:0 }}
                                            </small>
                                        </td>
                                        {% endif %}
                                        <td>
                                            <strong class="text-primary">₹{{ dept_data.year_total|floatformat:0 }}</strong>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% if total_budget > 0 %}
                                                    {% widthratio dept_data.year_total total_budget 100 %}%
                                                {% else %}
                                                    0%
                                                {% endif %}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-dark">
                                    <tr>
                                        <th class="ps-3 text-white">TOTAL</th>
                                        <th>
                                            <span class="badge bg-light text-dark">{{ total_students }}</span>
                                        </th>
                                        {% if view_type == 'monthly' or view_type == 'custom' %}
                                            <th class="text-white"><strong>₹{{ total_budget|floatformat:0 }}</strong></th>
                                        {% else %}
                                            <th class="text-white"><strong>₹{{ total_quarterly.0|floatformat:0 }}</strong></th>
                                            <th class="text-white"><strong>₹{{ total_quarterly.1|floatformat:0 }}</strong></th>
                                            <th class="text-white"><strong>₹{{ total_quarterly.2|floatformat:0 }}</strong></th>
                                            <th class="text-white"><strong>₹{{ total_quarterly.3|floatformat:0 }}</strong></th>
                                        {% endif %}
                                        <th class="text-white"><strong>₹{{ total_budget|floatformat:0 }}</strong></th>
                                        <th class="text-white"><strong>100%</strong></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Budget Data Available</h5>
                            {% if user.role == 'el_coordinator' %}
                            <p class="text-muted">Calculate payments first to generate budget data.</p>
                            <a href="{% url 'payment_calculation_bulk' %}" class="btn btn-primary">
                                <i class="fas fa-calculator me-2"></i>Calculate Payments
                            </a>
                            {% else %}
                            <p class="text-muted">Please contact the EL Coordinator to calculate payments and generate budget data.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Monthly Breakdown Chart -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Monthly Trend {{ current_year }}
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="monthlyTrendChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Department Distribution -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-donut me-2"></i>Department Distribution
                    </h6>
                </div>
                <div class="card-body">
                    {% if budget_data %}
                        {% for dept_data in budget_data %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="fw-semibold">{{ dept_data.department.code }}</span>
                                <br>
                                <small class="text-muted">{{ dept_data.student_count }} students</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">₹{{ dept_data.year_total|floatformat:0 }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if total_budget > 0 %}
                                        {% widthratio dept_data.year_total total_budget 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-chart-donut fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No data to display</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-bolt text-warning me-2"></i>Quick Actions
                    </h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'payment_reports' %}" class="btn btn-outline-primary">
                            <i class="fas fa-chart-bar me-2"></i>View Detailed Reports
                        </a>
                        <a href="{% url 'payment_rate_management' %}" class="btn btn-outline-info">
                            <i class="fas fa-cog me-2"></i>Manage Rates
                        </a>
                        <button class="btn btn-outline-secondary" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Print Budget
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #20c997);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #ff8f00);
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.table th {
    font-weight: 600;
}

.table:not(.table-dark) th {
    color: #495057;
}

.table-dark th {
    color: #ffffff !important;
}

.badge {
    font-weight: 500;
}

.opacity-75 {
    opacity: 0.75;
}

@media print {
    .btn, .card-header, nav {
        display: none !important;
    }
    
    .card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Trend Chart
    const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
    
    const months = {{ months|safe }};
    const monthlyData = [
        {% for dept_data in budget_data %}
            {
                label: '{{ dept_data.department.code }}',
                data: {{ dept_data.monthly_totals|safe }},
                borderColor: 'rgba(' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',1)',
                backgroundColor: 'rgba(' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',0.1)',
                tension: 0.4
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: monthlyData
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});

// Toggle date fields based on view type
function toggleDateFields() {
    const viewType = document.querySelector('select[name="view_type"]').value;
    const monthField = document.getElementById('month-field');
    const startDateField = document.getElementById('start-date-field');
    const endDateField = document.getElementById('end-date-field');
    
    // Hide all fields first
    monthField.style.display = 'none';
    startDateField.style.display = 'none';
    endDateField.style.display = 'none';
    
    // Show relevant fields based on view type
    if (viewType === 'monthly') {
        monthField.style.display = 'block';
    } else if (viewType === 'custom') {
        startDateField.style.display = 'block';
        endDateField.style.display = 'block';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleDateFields();
});
</script>
{% endblock %}
