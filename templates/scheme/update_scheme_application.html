{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load payment_extras %}
{% block title %}Update Application - ENL Assist{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- Page Header -->
            <div class="text-center mb-4">
                <h2 class="fw-bold text-primary">
                    <i class="fas fa-edit me-2"></i>Update Your Application
                </h2>
                <p class="text-muted">Review the feedback and update your application details</p>
            </div>

            <!-- Feedback Section -->
            {% if feedback_available %}
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Feedback from EL Coordinator
                    </h5>
                </div>
                <div class="card-body">
                    {% if general_comment %}
                    <div class="mb-3">
                        <h6 class="text-primary">General Comment:</h6>
                        <div class="alert alert-info">
                            {{ general_comment }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if field_feedback %}
                    <div class="mb-3">
                        <h6 class="text-danger">Fields that need correction:</h6>
                        <div class="row">
                            {% for field_name, message in field_feedback.items %}
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-warning d-flex align-items-start">
                                    <i class="fas fa-arrow-right text-warning me-2 mt-1"></i>
                                    <div>
                                        <strong>{{ field_name|title|replace_value:"_" }}:</strong><br>
                                        <small>{{ message }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instructions:</strong> Please review the feedback above and update the relevant fields in the form below. Your existing data has been preserved and you only need to modify the fields mentioned in the feedback.
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Application Form -->
            <div class="card shadow-lg">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-form me-2"></i>Application Form
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" onsubmit="return validateFiles()" id="updateForm">
                        {% csrf_token %}
                        
                        <!-- Student Information Section -->
                        <div class="section-header mb-4">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-user me-2"></i>Student Information
                            </h6>
                        </div>
                        
                        <div class="row">
                            <!-- Personal Information Fields -->
                            {% for field in form %}
                                {% if field.name in "first_name,middle_name,last_name,dob,address,state,annual_income,fathers_occupation,caste_category" %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ field.label }}
                                        {% if field.name in field_feedback %}
                                            <span class="badge bg-warning ms-2">
                                                <i class="fas fa-exclamation-circle"></i> Needs Update
                                            </span>
                                        {% endif %}
                                    </label>
                                    
                                    {% if field.name in field_feedback %}
                                        <div class="alert alert-warning py-2 mb-2">
                                            <small><strong>Feedback:</strong> {{ field_feedback|dict_key:field.name }}</small>
                                        </div>
                                    {% endif %}
                                    
                                    {{ field|add_class:"form-control" }}
                                    
                                    {% if field.help_text %}
                                        <small class="text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    
                                    {% for error in field.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- College Information Section -->
                        <div class="section-header mb-4 mt-4">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-graduation-cap me-2"></i>College Information
                            </h6>
                        </div>
                        
                        <div class="row">
                            {% for field in form %}
                                {% if field.name in "college_name,department,prn_number" %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ field.label }}
                                        {% if field.name in field_feedback %}
                                            <span class="badge bg-warning ms-2">
                                                <i class="fas fa-exclamation-circle"></i> Needs Update
                                            </span>
                                        {% endif %}
                                    </label>
                                    
                                    {% if field.name in field_feedback %}
                                        <div class="alert alert-warning py-2 mb-2">
                                            <small><strong>Feedback:</strong> {{ field_feedback|dict_key:field.name }}</small>
                                        </div>
                                    {% endif %}
                                    
                                    {{ field|add_class:"form-control" }}
                                    
                                    {% if field.help_text %}
                                        <small class="text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    
                                    {% for error in field.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Documents Section -->
                        <div class="section-header mb-4 mt-4">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-file-upload me-2"></i>Document Uploads
                            </h6>
                        </div>
                        
                        <div class="row">
                            {% for field in form %}
                                {% if field.field.widget.input_type == "file" %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ field.label }}
                                        {% if field.name in field_feedback %}
                                            <span class="badge bg-warning ms-2">
                                                <i class="fas fa-exclamation-circle"></i> Needs Update
                                            </span>
                                        {% endif %}
                                    </label>
                                    
                                    {% if field.name in field_feedback %}
                                        <div class="alert alert-warning py-2 mb-2">
                                            <small><strong>Feedback:</strong> {{ field_feedback|dict_key:field.name }}</small>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Show current file if exists -->
                                    {% if field.value %}
                                        <div class="mb-2">
                                            <small class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Current file: {{ field.value|file_name }}
                                            </small>
                                        </div>
                                    {% endif %}
                                    
                                    {{ field|add_class:"form-control" }}
                                    <small class="text-muted">Max size: 2MB. Leave empty to keep current file.</small>
                                    <span class="text-danger d-block" id="error_{{ field.name }}"></span>
                                    
                                    {% for error in field.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-success btn-lg px-5 me-3">
                                <i class="fas fa-paper-plane me-2"></i>Submit Updated Application
                            </button>
                            <a href="{% url 'student_dashboard' %}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(45deg, #007bff, #0056b3);
    }
    
    .section-header h6 {
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .form-control {
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    
    .alert {
        border-radius: 8px;
    }
    
    .badge {
        font-size: 0.7em;
    }
    
    .card {
        border-radius: 12px;
        border: none;
    }
    
    .card-header {
        border-radius: 12px 12px 0 0 !important;
    }
</style>

<script>
    function validateFiles() {
        const maxSize = 2 * 1024 * 1024;  // 2MB in bytes
        const fileInputs = document.querySelectorAll('input[type="file"]');
        let valid = true;
    
        fileInputs.forEach(input => {
            const errorSpan = document.getElementById(`error_${input.name}`);
            errorSpan.textContent = "";  // Clear previous errors
    
            if (input.files.length > 0) {
                const file = input.files[0];
                
                if (file.size > maxSize) {
                    errorSpan.textContent = `File size exceeds 2MB limit.`;
                    valid = false;
                }
            }
        });
    
        return valid;  // Prevent form submission if invalid
    }
    
    // Add confirmation dialog for form submission
    document.getElementById('updateForm').addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to submit your updated application? This will reset your application status to "Pending" for review.')) {
            e.preventDefault();
        }
    });
    
    // Highlight fields that need attention
    document.addEventListener('DOMContentLoaded', function() {
        const fieldsWithFeedback = document.querySelectorAll('.badge:contains("Needs Update")').parent().parent();
        fieldsWithFeedback.forEach(field => {
            field.style.border = '2px solid #ffc107';
            field.style.borderRadius = '8px';
            field.style.padding = '10px';
            field.style.backgroundColor = '#fff3cd';
        });
    });
</script>
{% endblock %}
